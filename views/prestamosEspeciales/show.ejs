<%- include('../partials/header', { title: 'Detalle del Préstamo Especial' }) %>

<div class="container-fluid px-4 mt-4">
  <div class="row">
    <div class="col-md-8">
      <div class="card border-0 shadow mb-4">
        <div class="card-header bg-primary text-white py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
              <i class="fas fa-info-circle me-2"></i>Detalle del Préstamo
            </h2>
            <div>
              <a href="/prestamos-especiales/<%= prestamo.id %>/editar" class="btn btn-light btn-sm me-2">
                <i class="fas fa-edit me-1"></i> Editar
              </a>
              <a href="/prestamos-especiales" class="btn btn-light btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Volver
              </a>
            </div>
          </div>
        </div>

        <div class="card-body">
          <% if (messages.success) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <%= messages.success %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% } %>
          <% if (messages.error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <%= messages.error %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% } %>

          <div class="row mb-4">
            <div class="col-md-6">
              <h5 class="mb-3"><i class="fas fa-user-tie me-2 text-primary"></i>Información del Cliente</h5>
              <div class="mb-2">
                <strong>Nombre:</strong> <%= prestamo.cliente_nombre %> <%= prestamo.cliente_apellidos %>
              </div>
              <div class="mb-2">
                <strong>Cédula:</strong> <%= prestamo.cliente_cedula %>
              </div>
              <div class="mb-2">
                <strong>Ruta/Zona:</strong> 
                <%= prestamo.ruta_zona ? `${prestamo.ruta_zona} - ${prestamo.ruta_nombre}` : 'No asignada' %>
              </div>
            </div>

            <div class="col-md-6">
              <h5 class="mb-3"><i class="fas fa-file-invoice-dollar me-2 text-primary"></i>Detalles del Préstamo</h5>
              <div class="mb-2">
                <strong>Estado:</strong> 
                <span class="badge bg-<%= prestamo.estado === 'pendiente' ? 'warning' : 
                                       prestamo.estado === 'aprobado' ? 'success' : 
                                       prestamo.estado === 'rechazado' ? 'danger' : 'secondary' %>">
                  <%= prestamo.estado.charAt(0).toUpperCase() + prestamo.estado.slice(1) %>
                </span>
              </div>
              <div class="mb-2">
                <strong>Fecha:</strong> <%= prestamo.fecha_creacion %>
              </div>
              <div class="mb-2">
                <strong>Forma de Pago:</strong> 
                <%= prestamo.forma_pago.charAt(0).toUpperCase() + prestamo.forma_pago.slice(1) %>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="card bg-light mb-3">
                <div class="card-header bg-secondary text-white">Resumen Financiero</div>
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Monto Aprobado:</span>
                    <strong>RD$ <%= prestamo.monto_aprobado.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Interés (<%= prestamo.interes_porcentaje %>%):</span>
                    <strong>RD$ <%= (prestamo.monto_aprobado * prestamo.interes_porcentaje / 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Total a Pagar:</span>
                    <strong class="text-success">RD$ <%= (prestamo.monto_aprobado * (1 + prestamo.interes_porcentaje / 100)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card bg-light mb-3">
                <div class="card-header bg-secondary text-white">Estado de Pagos</div>
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Total Pagado:</span>
                    <strong>RD$ <%= isNaN(totalPagado) ? '0.00' : totalPagado.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Interés Pagado:</span>
                    <strong>RD$ <%= interesPagado.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Capital Pagado:</span>
                    <strong>RD$ <%= capitalPagado.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Capital Restante:</span>
                    <strong class="text-primary">RD$ <%= prestamo.capital_restante.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección de Historial de Pagos -->
          <div class="card border-0 shadow mt-4">
            <div class="card-header bg-primary text-white py-3">
              <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historial de Pagos</h5>
            </div>
            <div class="card-body p-0">
              <% if (pagos && pagos.length > 0) { %>
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Fecha</th>
                        <th>Monto</th>
                        <th>Interés</th>
                        <th>Capital</th>
                        <th>Método</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% pagos.forEach(pago => { %>
                        <tr>
                          <td><%= moment(pago.fecha).format('DD/MM/YYYY') %></td>
                          <td>RD$ <%= pago.monto.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                          <td>RD$ <%= pago.interes_pagado.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                          <td>RD$ <%= pago.capital_pagado.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                          <td><%= pago.metodo.charAt(0).toUpperCase() + pago.metodo.slice(1) %></td>
                          <td>
                            <a href="/prestamos-especiales/<%= prestamo.id %>/recibo/<%= pago.id %>" 
                               class="btn btn-sm btn-outline-primary">
                              <i class="fas fa-receipt me-1"></i> Recibo
                            </a>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="alert alert-info m-3">
                  <i class="fas fa-info-circle me-2"></i> No se han registrado pagos para este préstamo.
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow mb-4">
        <div class="card-header bg-primary text-white py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
              <i class="fas fa-money-bill-wave me-2"></i>Registrar Pago
            </h3>
          </div>
        </div>
        <div class="card-body">
          <% 
          const puedePagar = prestamo.estado === 'aprobado' && 
                           !isNaN(parseFloat(prestamo.capital_restante)) && 
                           parseFloat(prestamo.capital_restante) > 0;
          
          const estaPagado = !isNaN(parseFloat(prestamo.capital_restante)) && 
                           parseFloat(prestamo.capital_restante) <= 0;
          %>
          
          <% if (puedePagar) { %>
            <a href="/prestamos-especiales/<%= prestamo.id %>/pago" class="btn btn-success w-100">
              <i class="fas fa-plus-circle me-2"></i>Nuevo Pago
            </a>
            <div class="mt-2 text-center">
              <small class="text-muted">Capital restante: RD$ <%= parseFloat(prestamo.capital_restante).toFixed(2) %></small>
            </div>
          
          <% } else if (estaPagado) { %>
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>Préstamo completamente pagado
            </div>
          
          <% } else { %>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-circle me-2"></i>
              <% if (prestamo.estado !== 'aprobado') { %>
                Préstamo no está aprobado
              <% } else { %>
                No se puede procesar pagos (capital restante: <%= prestamo.capital_restante %>)
              <% } %>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Último Pago -->
      <% if (pagos && pagos.length > 0) { %>
        <div class="card border-0 shadow">
          <div class="card-header bg-primary text-white py-3">
            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Último Pago</h5>
          </div>
          <div class="card-body">
            <div class="mb-2">
              <strong>Fecha:</strong> <%= moment(pagos[0].fecha).format('DD/MM/YYYY') %>
            </div>
            <div class="mb-2">
              <strong>Monto:</strong> RD$ <%= pagos[0].monto.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
            </div>
            <div class="mb-2">
              <strong>Método:</strong> <%= pagos[0].metodo.charAt(0).toUpperCase() + pagos[0].metodo.slice(1) %>
            </div>
            <a href="/prestamos-especiales/<%= prestamo.id %>/recibo/<%= pagos[0].id %>" 
               class="btn btn-primary w-100 mt-2">
              <i class="fas fa-receipt me-2"></i> Ver Recibo
            </a>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>

<style>
  .table-hover tbody tr:hover {
    background-color: #f8f9fa;
  }
  .badge {
    font-size: 0.85em;
    padding: 0.35em 0.65em;
  }
</style>