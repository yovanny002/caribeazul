<%- include('../partials/header', { title: 'Editar Préstamo' }) %>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Contrato de Financiamiento - Financiera Caribe Azul</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #0b76ff;
            --secondary-color: #f4f7fb;
            --text-color: #333;
            --white: #fff;
            --shadow: 0 5px 18px rgba(0, 0, 0, 0.1);
            --border-radius: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .card {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #cfd8e2;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .button-color{
            background-color: red;
        }

        button:hover {
            background: #005fcc;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: space-between;
        }

        /* Estilos para bloques del formulario */
        .form-block {
            display: none;
        }

        .form-block.active {
            display: block;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .progress-step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
            color: #666;
        }

        .progress-step.active {
            background-color: var(--primary-color);
            color: white;
        }

        .progress-step.completed {
            background-color: #4CAF50;
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow: auto;
        }

        .modal-content {
            background-color: var(--white);
            margin: 2% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 10px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-color);
        }

        #contratoFinal {
            white-space: pre-wrap;
            line-height: 1.7;
            font-size: 14px;
            text-align: justify;
            margin-top: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header img {
            max-width: 150px;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .card {
                padding: 20px;
            }

            .modal-content {
                padding: 20px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
        }
        
        /* ESTILOS DE IMPRESIÓN CORREGIDOS */
        @media print {
            body * {
                visibility: hidden;
            }
            .modal, .modal * {
                visibility: visible;
            }
            .modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background: white;
                overflow: visible;
                display: block !important;
            }
            .modal-content {
                margin: 0;
                padding: 20px;
                box-shadow: none;
                width: 100%;
                max-width: 100%;
                height: auto;
                border: none;
                overflow: visible;
                position: relative;
            }
            .close, .modal-buttons {
                display: none;
            }
            #contratoFinal {
                white-space: pre-wrap;
                line-height: 1.5;
                font-size: 12px;
                text-align: justify;
                margin-top: 0;
                max-height: none;
                overflow: visible;
                page-break-inside: avoid;
            }
            /* Asegurar que el contenido no se corte entre páginas */
            .modal-content {
                page-break-inside: avoid;
            }
            /* Mejorar la legibilidad en impresión */
            body {
                font-size: 12px;
                line-height: 1.4;
            }
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container-fluid px-4 mt-4">
        <div class="card border-0 shadow">
            <div class="card-header bg-primary text-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">
                        <i class="fas fa-file-contract me-2"></i>Generador de Contrato de Financiamiento
                    </h2>
                    <a href="/contratos" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Volver a Contratos
                    </a>
                </div>
            </div>

            <div class="card-body">
                <div class="header">
                    <h1>Financiera Caribe Azul <br>Contrato de Financiamiento</h1>
                </div>

                <div class="alert alert-success alert-dismissible fade show d-none" id="successAlert" role="alert">
                    <span id="successMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <div class="alert alert-danger alert-dismissible fade show d-none" id="errorAlert" role="alert">
                    <span id="errorMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div class="info-box">
                    <h4><i class="fas fa-info-circle me-2"></i>Información Importante</h4>
                    <p class="mb-0">Complete todos los campos obligatorios (*) para generar el contrato. Puede asociar el contrato a un cliente y préstamo existente si lo desea.</p>
                </div>

                <div class="card">
                    <form id="formContrato">
                        <!-- Indicador de progreso -->
                        <div class="progress-indicator">
                            <div class="progress-step active" data-step="0">1</div>
                            <div class="progress-step" data-step="1">2</div>
                            <div class="progress-step" data-step="2">3</div>
                            <div class="progress-step" data-step="3">4</div>
                            <div class="progress-step" data-step="4">5</div>
                        </div>
                        
                        <!-- Bloque 0: Asociaciones -->
                        <div class="form-block active" id="block-0">
                            <h2><i class="fas fa-link me-2"></i>Asociaciones (Opcional)</h2>
                            
                            <div class="form-group">
                                <label>Cliente existente</label>
                                <select name="cliente_id" class="form-control" id="clienteSelect">
                                    <option value="">Seleccionar cliente existente...</option>
                                    <!-- Los clientes se cargarán dinámicamente -->
                                </select>
                                <small class="text-muted">Si selecciona un cliente, algunos campos se completarán automáticamente</small>
                            </div>

                            <div class="form-group">
                                <label>Préstamo asociado</label>
                                <select name="prestamo_id" class="form-control" id="prestamoSelect">
                                    <option value="">Seleccionar préstamo existente...</option>
                                    <!-- Los préstamos se cargarán dinámicamente -->
                                </select>
                                <small class="text-muted">Si selecciona un préstamo, los datos de financiamiento se completarán automáticamente</small>
                            </div>
                            
                            <div class="btn-group">
                                <button type="button" id="btn-next-0">Siguiente</button>
                            </div>
                        </div>
                        
                        <!-- Bloque 1: Datos del Cliente -->
                        <div class="form-block" id="block-1">
                            <h2><i class="fas fa-user me-2"></i>Datos del Cliente</h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nombre completo*</label>
                                    <input type="text" placeholder="Ej: Juan Pérez" name="nombre_cliente" id="nombre_cliente" required>
                                </div>
                                <div class="form-group">
                                    <label>Nacionalidad</label>
                                    <input type="text" placeholder="Ej: Dominicana" name="nacionalidad" id="nacionalidad" value="Dominicana">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ocupación*</label>
                                    <input type="text" placeholder="Ej: Ingeniero" name="ocupacion" id="ocupacion" required>
                                </div>
                                <div class="form-group">
                                    <label>Tipo de documento*</label>
                                    <select name="tipo_documento" id="tipo_documento" required>
                                        <option value="cédula">Cédula</option>
                                        <option value="pasaporte">Pasaporte</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Número de documento*</label>
                                    <input type="text" placeholder="Ej: 001-1234567-8" name="numero_documento" id="numero_documento" required>
                                </div>
                                <div class="form-group">
                                    <label>Teléfono*</label>
                                    <input type="tel" placeholder="Ej: 809-123-4567" name="telefono" id="telefono" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Dirección completa*</label>
                                <textarea name="direccion" id="direccion" placeholder="Ej: Calle Principal #123, Sector Los Jardines, Santo Domingo Este" rows="2" required></textarea>
                            </div>

                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" placeholder="Ej: juan.perez@email.com" name="email" id="email">
                            </div>
                            
                            <div class="btn-group">
                                <button type="button" id="btn-prev-1">Anterior</button>
                                <button type="button" id="btn-next-1">Siguiente</button>
                            </div>
                        </div>
                        
                        <!-- Bloque 2: Vehículo -->
                        <div class="form-block" id="block-2">
                            <h2><i class="fas fa-car me-2"></i>Vehículo</h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo de vehículo*</label>
                                    <select name="tipo_vehiculo" id="tipo_vehiculo" required>
                                        <option value="">Seleccionar tipo...</option>
                                        <option value="Automóvil">Automóvil</option>
                                        <option value="Camioneta">Camioneta</option>
                                        <option value="Motocicleta">Motocicleta</option>
                                        <option value="Camión">Camión</option>
                                        <option value="Jeep">Jeep</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Marca*</label>
                                    <input type="text" placeholder="Ej: Toyota" name="marca" id="marca" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Modelo*</label>
                                    <input type="text" placeholder="Ej: Corolla" name="modelo" id="modelo" required>
                                </div>
                                <div class="form-group">
                                    <label>Año*</label>
                                    <input type="text" placeholder="Ej: 2023" name="anio" id="anio" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Placa*</label>
                                    <input type="text" placeholder="Ej: ABC123" name="placa" id="placa" required>
                                </div>
                                <div class="form-group">
                                    <label>Color*</label>
                                    <input type="text" placeholder="Ej: Rojo" name="color" id="color" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Número de chasis*</label>
                                <input type="text" placeholder="Ej: 1HGCM82633A123456" name="chasis" id="chasis" required>
                            </div>
                            
                            <div class="btn-group">
                                <button type="button" id="btn-prev-2">Anterior</button>
                                <button type="button" id="btn-next-2">Siguiente</button>
                            </div>
                        </div>
                        
                        <!-- Bloque 3: Financiamiento -->
                        <div class="form-block" id="block-3">
                            <h2><i class="fas fa-money-bill-wave me-2"></i>Financiamiento</h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Precio total del vehículo*</label>
                                    <input type="number" placeholder="Ej: 500000" name="precio_total" id="precio_total" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label>Monto financiado*</label>
                                    <input type="number" placeholder="Ej: 400000" name="monto_financiado" id="monto_financiado" step="0.01" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Cantidad de cuotas*</label>
                                    <select name="cantidad_cuotas" id="cantidad_cuotas" required>
                                        <option value="12">12 cuotas</option>
                                        <option value="24" selected>24 cuotas</option>
                                        <option value="36">36 cuotas</option>
                                        <option value="48">48 cuotas</option>
                                        <option value="60">60 cuotas</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Monto por cuota*</label>
                                    <input type="number" placeholder="Ej: 18000" name="monto_cuota" id="monto_cuota" step="0.01" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Fecha primera cuota*</label>
                                    <input type="date" name="fecha_primera_cuota" id="fecha_primera_cuota" required>
                                </div>
                                <div class="form-group">
                                    <label>Fecha última cuota*</label>
                                    <input type="date" name="fecha_ultima_cuota" id="fecha_ultima_cuota" required>
                                </div>
                            </div>
                            
                            <div class="btn-group">
                                <button type="button" id="btn-prev-3">Anterior</button>
                                <button type="button" id="btn-next-3">Siguiente</button>
                            </div>
                        </div>
                        
                        <!-- Bloque 4: Seguro -->
                        <div class="form-block" id="block-4">
                            <h2><i class="fas fa-shield-alt me-2"></i>Seguro</h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo de seguro*</label>
                                    <select name="tipo_seguro" id="tipo_seguro" required>
                                        <option value="full">Full</option>
                                        <option value="deuda">Deuda</option>
                                        <option value="terceros">Terceros</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Monto seguro*</label>
                                    <input type="number" placeholder="Ej: 5000" name="monto_seguro" id="monto_seguro" step="0.01" required>
                                </div>
                            </div>

                            <div class="info-box">
                                <h4><i class="fas fa-exclamation-triangle me-2"></i>Nota Importante</h4>
                                <p class="mb-0">Al generar el contrato, este será guardado en el sistema y podrá ser consultado, descargado e impreso en cualquier momento desde la lista de contratos.</p>
                            </div>
                            
                            <div class="btn-group">
                                <button type="button" id="btn-prev-4">Anterior</button>
                                <button type="submit">Generar Contrato</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar el contrato -->
    <div id="modalContrato" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Contrato Generado</h2>
            <div id="contratoFinal"></div>
            <div class="modal-buttons">
                <button id="btnCopiar">Copiar Contrato</button>
                <button id="btnImprimir">Imprimir Contrato</button>
                <button id="btnCerrar" class="button-color">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Template del contrato
        const template = `CONTRATO DE FINANCIAMIENTO DE VEHÍCULO DE MOTOR AL AMPARO DE LA Ley No. 483 SOBRE VENTA CONDICIONAL DE MUEBLES
De una parte, CARIBE AZUL, S.R.L, entidad bancaria organizada y existente conforme a las leyes de la República Dominicana, r.n.c. num. 133-37493-5 con su asiento social y oficina principal ubicada en la calle H, Numero 15, Andres, Boca Chica, Provincia de Santo Domingo Restauración No.127, esquina calle Jácuba, de la ciudad de Santiago de los Caballeros, República Dominicana, representada por el (la) señor (a) CRISTIAN VARGAS, de nacionalidad Dominicana, Profesión u ocupación Comerciante, portador (a) de la Cédula de Identidad y Electoral No. 001-1497135-1, domiciliado (a) y residente en en esta ciudad de Andres, Boca Chica, Provincia de Santo Domingo, en su calidad de Encargado de Sucursal, y quien en lo adelante se denominará EL ACREEDOR;
De otra parte: (1) {{nombre_cliente}}, de nacionalidad {{nacionalidad}}, de profesión u ocupación {{ocupacion}}, portador del {{tipo_documento}} Num. {{numero_documento}}, domiciliado (a) y residente en {{direccion}} quien (es) en lo adelante y para lo fines y consecuencias del presente acuerdo, ya sea de manera conjunta o individual, se denominará (n) como EL DEUDOR (A)/ LOS DEUDORES; Se hace constar que, en lo adelante del presente acuerdo, cuando se nombre de manera conjunta a la empresa PINALES HERMANOS SRL, el señor (a) JULIO CESAR DE LA ROSA MONTERO denominaran LAS PARTES. HAN pactado lo siguiente:
                                                                PREAMBULO:
POR CUANTO: El señor (a) {{nombre_cliente}}, está interesado en la adquisición del mueble que más adelante se describirá y EL VENDEDOR o LA COMPAÑIA está dispuesta a realizar la venta de dicho mueble, sujeta a las condiciones que se especificaran más adelante. Pero en el entendido de que el presente contrato relativo a la venta pre aludida, deberá estar regido, y en ello consienten ambas partes contratantes de una manera formal, por las prescripciones y por los privilegios establecidos por la ley No.483 denominada LEY SOBRE VENTAS CONDICIONALES DE MUEBLES, promulgada por el Poder Ejecutivo el día 9 de noviembre de 1964 y publicada en la Gaceta Oficial No.8904 de fecha 14 de noviembre de 1964.
POR TANTO: Y en el entendido de que el presente preámbulo constituye parte integral de este contrato, sin lo cual LAS PARTES no consentirían el mismo, ha sido PACTADO Y CONVENIDO el contrato contenido en las siguientes estipulaciones:
                            SE HA CONVENIDO Y PACTADO LO SIGUIENTE:
ARTICULO PRIMERO: OBJETO. EL VENDEDOR o LA COMPAÑIA Vende a LA SEGUNDA PARTE lo siguiente mueble de su pertenencia, pero bajo la condición expresa y formal de que el mismo no llegara a ser propiedad de EL COMPRADOR sino después de haber pagado el precio total de la venta, según se especificara más adelante:
VEHICULO TIPO {{tipo_vehiculo}}, MARCA {{marca}}, MODELO {{modelo}}, AÑO: {{anio}}, PLACA: {{placa}}, CHASIS: {{chasis}} COLOR: {{color}}.
ARTICULO SEGUNDO: PRECIO DE VENTA. EL COMPRADOR conviene en comprar el mueble antes especificado por la suma y precio acordado por ambas partes de: RD$ {{precio_total}} que ha sido fijado por el VENDEDOR o COMPAÑÍA y aceptado por EL COMPRADOR.
ARTÍCULOS TERCERO: TERMINO FORMA DE PAGO  EL COMPRADOR se compromete a pagar {{cantidad_cuotas}} meses  iguales y consecutivos de capital e interés  por valor de RD$ {{monto_cuota}}, los días  que contaremos  los días (03) tres de cada mes subsiguiente el siguiente día hábil, si fuese feriado no laborable, siendo la primera cuota el (3) tres del mes de {{fecha_primera_cuota}} y la ultima el día (3) tres del mes de {{fecha_ultima_cuota}} por un monto de RD$ {{monto_financiado}} vencimiento total de capital, intereses y demás accesorios, EL VENDEDOR o COMPAÑIA se reserva el derecho de aceptar el pago de cualquier suma adeudada, con posterioridad a su vencimiento.
PARRAFO I: Es expresamente convenido que si el pago de una cuota se realiza después de los cuatro (04) días siguientes a la fecha en el cual ella es pagada LA SEGUNDA PARTE o EL COMPRADOR, estará obligado a pagar diarios por retraso la suma de CUARENTA  Y UN  PESOS CON 47/100 (RD$41.47) sobre el monto de la cuota atrasada, estipulando que constituye una clausura penal a cargo de LA SEGUNTA PARTE o EL COMPRADOR, sin embargo EL VENDEDOR o LA COMPAÑIA acuerda aceptar cualquier pago completo de una cuota sin esta penalidad si es hecho dentro del periodo de gracia de cuatro (04) días contados desde la fecha en la cual esa cuota es pagadera.
PARRAFO II: Todos los pagos de debe realizar  LA SEGUNDA PARTE o EL COMPRADOR con motivo del presente y/o compensación que haga EL VENDEDOR o LA COMPAÑIA deberán ser hecho, sin necesidad requerimiento alguno, en el asiento social de esta última y serán aplicado en el siguiente orden: a) A los gastos legales y honorarios profesionales en que incurra LA VENDEDORA o LA COMPAÑIA con motivo de la formalización y/o ejecución de este contrato, b) Cargos por mora c) A cualesquiera suma que EL ACREEDOR Hubiese tenido que avanzar o pagar por cuenta LA SEGUNDA PARTE o EL COMPRADOR, d)  los intereses,  y demás accesorios de la suma prestadas , e) El capital.

PARRAFO III: LA SEGUNDA PARTE o EL COMPRADOR, entiende y acepta que en caso de cancelación anticipada debe pagar los primeros seis (06) meses de cuotas fijas luego el capital adeudado.
ARTICULO CUARTO: PAGARE.  En representación del préstamo de se trata, LA SEGUNDA PARTE O COMPRADOR, suscribe un pagare a favor y orden de LA VENDEDORA O COMPAÑIA, el cual considera como parte accesoria del presente contrato. En caso de exigibilidad del crédito, EL VENDEDOR O LA COMPAÑIA podrá perseguir indistintamente los bienes los bienes personales de la SEGUNGA PARTE O COMPRADOR, mediante el cobro de este pagare, sin que ello implique renuncia a la venta condicional que por este mismo contrato se le otorga y aun cuando se encuentre persiguiendo su ejecución.
ARTICULO QUINTO: EXAMEN ESTADO DEL MUEBLE EL COMPRADOR, declara bajo la fe de juramento y garantiza que conservara la posesión del mueble cuidadosa y gratuitamente sin que pueda pretender compensación alguna por concepto de esa conversación, así mismo EL COMPRADOR responderá frente al VENDEDOR de la perdida, daños o deterioros que pueda sufrir el vehículo indicado.
ARTICULO SEXTO: POLIZA DE SEGURO. EL COMPRADOR se compromete a contratar y mantener vigente con una compañía de seguro aceptable para EL VENDEDOR, una póliza de seguro a todo riesgo sobre los muebles antes descritos por el valor del mismo. El veneficio de esta póliza será cedido a favor de EL VENDEDOR, para lo cual se realizan las diligencias pertinentes para tales fines EL COMPRADOR, se obliga a mantener en vigor dicha póliza de seguros por renovaciones sucesivas mientras EL COMPRADOR continue siendo deudor de EL VENDEDOR, de acuerdo a este contrato. En el caso de que dejare de renovar la póliza antes del vencimiento del término, EL VENDEDOR estará autorizado irrevocablemente para hacer por cuenta de sin que esto implique de parte de EL VENDEDOR una obligación, debiendo EL COMPRADOR, pagar inmediatamente al VENDEDOR el valor correspondiente de la póliza de seguro, el cual será productivo de interés y estará garantizado por la garantía otorgada por medio del presente contrato.
PARRAFO I:  LA SEGUNDA PARTE O COMPRADOR entiende y acepta que deberá pagar mensualmente al VENDEDOR la suma de RD$ {{monto_seguro}} adicionales sobre el valor de la cuota establecida en el artículo tercero del presente contrato durante la vigencia del préstamo, por concepto de pago de prima seguro del vehículo objeto de financiamiento. Así mismo LA SEGUNDA PARTE o EL COMPRADOR acepta que será cobrado debitado este importante valor con privilegio de los valores que este entregue a EL VENDEDOR
PARRAFO II: LA SEGUNDA PARTE o EL COMPRADOR entiende y acepta que la compañía de corretaje de seguros que estará a cargo de la gestión y administración de su póliza de seguros será   SEGUROS LA INTERNACIONAL S.A, durante la vigencia del préstamo. No pudiendo este bajo ninguna circunstancia hacer cambios, nombramientos o modificaciones a dicho condición. LA VENDEDORA o LA COMPAÑIA podrá realizar modificaciones en la tasa de interés anual establecida en el préstamo e incluye la pérdida del beneficio del término, en caso de que por causas y/o solicitud de LA SEGUNDA PARTE o EL COMPRADOR sea modificado la empresa d corretaje. La segunda parte o comprador acepta la condición de que en caso de no ponerle un seguro ful al vehículo por cualquier razón se le pondrá un seguro de deuda que será igual al 2% del total del préstamo será renovado anualmente por la misma suma hasta la vigencia del préstamo.
PARRAFO III: Durante el periodo de gestión y contratación de las pólizas, los riesgos correrán a cargo ya de EL COMPRADOR. Así mismo, las partes acuerdan que EL COMPRADOR, siempre asumirá los riesgos, si durante algún siniestro se verifica que la póliza haya caducado y su renovación no ha sido en su totalidad, siendo responsable frente a terceros de cualquier daño de naturaleza moral o material ocasionado por el vehículo objeto de financiamiento en el presente contrato.
PARRAFO IV: EL COMPRADOR declara que, al momento de suscribir el presente convenio, posee licencia d conducir y se compromete a mantenerla en vigencia durante el periodo de duración de este contrato y sus posibles modificaciones.
ARTICULO SEPTIMO: DISPOSITIVOS GPS. EL COMPRADOR entiende y reconoce que el mueble del presente contrato posee un dispositivo de rastreo y localización bajo ninguna circunstancia está autorizado a remover, tocar o manipular el dispositivo instalado. De suceder alguna de estas situaciones, producirá de pleno derecho la pérdida del beneficiario dl plazo que ha sido acordado para realizar el pago de los valores a que se refiere este contrato. PARRAFO I: En caso de perdida, daño y rotura del dispositivo GPS EL COMPRADOR se obliga a reponerlo en su totalidad, el cual tiene un costo de TRECE MIL PESOS CON/00 (RD 13,000.00) los cuales serán cargados y cobrados con privilegio de los valores que este entregue a la COMPAÑIA.
ARTICULO OCTAVO: GUARDA Y CONSERVACIÓN DEL MUEBLE. EL COMPRADOR el riesgo del mueble, siendo por tanto responsable de la perdida, destrucción o deterioro que sufran, así como de los daños que causaren. En consecuencia. EL VENDEDOR o COMPAÑIA no podrá en ningún momento ser responsable de cuales quiera u otros compromisos en que incurran , en caso de que cualquier persona intentare contra EL VENDEDOR o LA COMPAÑIA alguna acción en cobro de indemnización de otro género por causa de accidente o por otros motivos causados por EL COMPRADOR o por los muebles mismos o quien lo tuviera en su poder o guarda siendo obligación de estos últimos tomara su cargo las responsabilidades que por tales conceptos reclamantes por cualquier desembolso que tuviera que hacer, incluyendo los costos del litigio que tuviera que hacer.
PARRAFO I: Es entendido y convenido que es responsabilidad de EL COMPRADOR el pago de todos los impuestos derechos y gastos requeridos para el registro de la inscripción del presente contrato de venta condicionales, así como del derecho de propiedad o Matricula, placa de circulación, licencia y cuales quiera otros impuestos que se apliquen a vehículo de motor.
ARTICULO NOVENO: TITULARIDAD DE DERECHO. Es entendido y convenido que EL COMPRADOR no adquirirá la propiedad del mueble , si no después de haber realizado el pago completo de la suma especificada como precio de venta, que en consecuencia del mueble es de la propiedad absoluta de EL VENDEDOR o La COMPAÑIA o de sus continuadores jurídicos, cesionarios o causahabientes, hasta tanto EL COMPRADOR haya pagado totalmente el precio de la venta en la forma y plazos estipulados , y hasta cuando haya cumplido con todas y cada una de las obligaciones aceptadas por el en este contrato. Por consiguiente , EL VENDEDOR o LA COMPAÑIA está autorizada a requerir en el Registro de Ventas Condicional es la inscripción del presente contrato , a fin de que el surta los efectos atribuidos a tal es contratos por ley de Ventas Condicional de Muebles No. 483, promulgada en fecha 9 de Noviembre de 1964 y publicada en la  Gaceta Oficial No. 8904 del 14 de Noviembre de 1964, y EL COMPRADOR no podrá vender ,transferir o en forma alguna enajenar, destruir, deteriorar u ocultar, ni trasladar fuera del territorio de la Republica Dominicana, los muebles objectos de la presente venta, sin el consentimiento escrito y formal de EL VENDEDOR o COMPAÑIA.
PARRAFO II: EL VENDEDOR o LA COMPAÑIA se reserva el derecho de hacer examinar los muebles por cualquier persona designada por ella, cuantas veces lo estime conveniente, con el objeto de cerciorarse de su estado y funcionamiento y del cumplimiento de las obligaciones de EL COMPRADOR. Este a la vez se obligan a permitir en cualquier tiempo el examen, presentado el mueble o permitiendo el acceso de la persona designada para examinarlo al lugar donde se encuentren, entendiéndose que la filtración de esta obligación da a la resolución del contrato en la forma prevista en el presente contrato.
ARTICULO DECIMO: PERDIDA DEL MUEBLE. En caso de que los muebles vendidos se perdieren o fuesen destruidos o se deliraren de manera que afecte sensiblemente su valor, aun por causa fortuita o de fuerza mayor o accidente, se hará inmediatamente exigible todos los pagos pendientes sin que el comprador pueda objetar nada contra estas diligencias desde el momento de la firma de este Contrato, a cualquier reclamación fundada en esta causa de entrega de parte de EL COMPRADOR, así como a la reivindicaron cuando hubiere lugar.
ARTICULO DECIMO PIMERO: PROCEDIMIENTO DE EJECUCION. Para la ejecución de la venta condicional contenida en el presente contrato, dicha ejecución se llevará a cabo de acuerdo con las reglas y disposiciones establecidas por el articulo diez (10) y siguiente d ley venta condicionales de Muebles No. 483, promulgada en 9 de noviembre de 1964 y publicada en la Gaceta Oficial No. 8904 del 14 noviembre de 1964.
PARRAFO I: Se establece que cuando EL COMPRADOR registrará atrasos por más de cuarenta y cinco (45) días para el pago de las cuotas de las establecidas en el presente contrato, así como cualquiera de las prohibiciones, producirá de pleno derecho la pérdida del beneficio del plazo que le ha sido acordado para realizar el pago de los valores a que se refiere este contrato. En consecuencia, dichos valores se harán inmediatamente exigibles, de pleno derecho y sin necesidad de notificación alguna y ejecutable el vehículo que se contare en el presente contrato. Queda entendido que el retraso del VENDEDOR o LA COMPAÑIA en el ejercicio de este derecho, no implica en modo alguna renuncia o caducidad del mismo.
PARRAFO II: En caso de retraso en más de cuarenta y cinco (45) días, EL VENDEDOR o LA COMPAÑIA notificara vía acto de alguacil al COMPRADOR en un acto de intimación de pago con secuestro del mueble, otorgándole un plazo de diez (10) días francos para pagar la suma adeudada requerida por EL VENDEDOR o LA COMPAÑIA, pudiendo este último sin intervención judicial ni procedimientos alguno revindicar el mueble vendido en cualesquiera manos que se encuentre. Por consiguiente, EL COMPRADOR podrá requerir, cuando así le convenga, que el alguacil actuante coloque el mueble bajo custodia de un guardián desde el momento en que se le notifique a la intimación a que el presente párrafo.
PARRAFO III: En el caso de que hubiere lugar a la resolución de la venta en conformidad con las cláusulas anteriores y una vez que EL COMPRADOR haya entregado el mueble al VENDEDOR o COMPAÑIA la totalidad de los pagos hechos por EL COMPRADOR en ejecución del contrato, incluyendo pago inicial y el valor del mueble usado recibido a cuenta del precio, si fuere el caso, quedara a veneficio de EL VENDEDOR o LA COMPAÑIA sin ninguna class de compensación para el COMPRADOR, como reparación convenida entre las partes por presente clausula, de los daños y perjuicios sufridos por EL VENDEDOR o LA COMPAÑIA como consecuencia de la inejecución del contrato y su resolución por incumplimiento de las obligaciones de EL COMPRADOR , sin perjuicio del derecho que tiene EL VENDEDOR o LA COMPAÑIA de perseguir el cobro de las obligaciones suscritas por EL COMPRADOR en virtud del contrato y vencidas hasta el momento de su resolución . Las partes reconocen en consecuencia, que EL COMPRADOR renuncia a todo ajuste de cuentas en ejercicio de la facultad discrecional que le otorga el artículo 13 de ley de Venta Condicionales de Muebles, dejando constancia que esa su voluntad expresa. Sin embargo, EL COMPRADOR admite y reconoce que EL VENDEDOR o LA COMPAÑIA tendrá potestad de pleno derecho para ejercer unilateralmente dicho ajuste de cuentas, en caso de que el vehículo sea recuperado con evidentes señales de depreciación y deterioro, si considera que con ello contribuye a obtener la recuperación de su crédito.
PARRAFO IV: En caso de apoderamiento judicial de Abogado para el cobro de la suma adeudada EL COMPRADOR deberá pagar a aquel los horarios profesionales, establecidos en un treinta por ciento (30%) de la suma reclamada, sin perjuicio de los gastos legales e impuestos incurridos en esas gestiones, teniendo a tales fines este acto carácter y fuerza de un pacto de cuota litis.
ARTICULO DECIMO SEGUNDO INDIVISIBILIDAD En caso de que EL COMPRADOR falleciere antes de haber pagado la totalidad del precio de la venta, la porción debida de hará inmediatamente exigible y EL VENDEDOR o LA COMPAÑIA podrá pedir el pago integro de dicha porción. Además, las parte contratantes convienen en darle carácter de individualidad a todas las obligaciones asumidas por EL COMPRADOR en este contrato. Por lo tanto, EL VENDEDOR o LA COMPAÑIA en caso de muerte del COMPRADOR antes de haber pagado el precio integro de la venta, podrá perseguir a uno o cuales quiera de EL COMPRADOR por toda la porción del precio no pagada y podrá EL VENDEDOR igualmente, en caso de que uno cualquiera de los herederos de COMPRADOR no pague esa porción, precederá la incautación de los muebles vendidos, dirigiendo el procedimiento de incautación contra el demás integrante sucesión.

ARTICULO DECIMO TERCERO: EL COMPRADOR le conviene y consciente en EL VENDEDOR o COMPAÑIA podrá sin necesidad de ninguna modificación, vender, ceder o de cualquier otro modo disponer en todo o en parte de los derechos y acciones que se deriven del presente contrato y del registro del mismo a favor de cualquier otra persona o entidad. EL COMPRADOR no podrá arrendar ni prestar el mueble y no podrá traspasar en totalidad o en parte los derechos que tiene o puedan tener en el presente contrato, sin el consentimiento previo y por escrito de EL VENDEDOR o COMPAÑIA.
ARTICULO DECIMO CUARTO: COMPETENCIA. Las partes con vienen en atribuir competencia al juzgado de la primera circunscripción del Distrito Nacional, Para la ejecución forzosa de este contrato y para todo cuantos litigios puedan surgir con motivo de este contrato o en relación con la consecuencia EL COMPRADOR renuncia a la competencia de los tribunales de su domicilio, en caso de ser distinto.
ARTICULO DECIMO QUINTO: NO DEROGACIÓN. Este contrato contiene todo cuanto se ha pactado y convenido  entre las partes y no se puede alegar ningún contrato, clausula o promesa verbal que diga EL COMPRADOR ha sido hecha por EL VENDEDOR o COMPAÑIA ni por ningún funcionario, vendedor, distribuidor o agente de esta que pueda colidir con los términos de este contrato, o modificarlas clausulas, condición eso términos escritos de este , así como ninguna promesa de entregar ninguna cosa, pieza o servicio especificado en este contrato ni será responsable LA VENDEDORA o LA COMPAÑIA por ningún convenio o promesa de cualquier especie que fuere en relación con este negocio que no esté explícitamente contenido en este contrato.
ARTICULO DECIMO SEXTO: EL COMPRADOR declara ser mayor de edad y plenamente capaz para con sentir el presente contrato, el cual han leído y comprendido en todas sus partes y reconocen haber recibido un ejemplar del mismo debidamente firmado.
ARTICULO DECIMO SEPTIMO: EL COMPRADOR por medio del presente documento autoriza de manera expresa a LA PRIMERA PARTE o EL VENDEDOR a que puedan ser consulado en las bases de datos de los Buros de Información Crediticia (BIC) y autoriza además a suministrar a dichos Buro, la Información necesaria a los fines de permitir la evaluación de crédito por parte de aquellas instituciones del sistema financiero suscritas a los referidos Buro. EL COMPRADOR reconoce y acepta que el suministro de la referida información por parte de EL VENDEDOR o LA COMPAÑIA y/o los buros de Información Crediticia (BIC), o por cualquier accionista, funcionario o empleado de una de estas, no constituirá una violación al secreto profesional de acuerdo al artículo 377 del código penal. En consecuencia, EL COMPRADOR renuncia formal y expresamente a ejercer cualquier opción de demanda o reclamación a fines de obtener una compensación en daños y perjuicios por la revelación de información a fines de obtener una compensación en daños y perjuicios por la revelación de información o por haber suministrado una información inexacta.
ARTICULO DECIMO OCTAVO: Para todos los fines y consecuencias legales del presente contrato, las partes se remiten a las disposiciones establecidas en la Ley de Ventas Condicionales de Muebles No.483, promulgada en fecha 9 de noviembre de 1964 y publicada en Gaceta Oficial No. 8904 del 14 de noviembre de 1964, para los fines de atribuciones de ejecución del presente contrato.
Hecho y firmado en dos originales de un mismo tenor, firmados y rubricados por cada una de las partes, en la ciudad de Santo Domingo, Distrito Nacional Capital de la República Dominicana, el dia  (3) Tres del mes de Marzo del año dos mil veinticinco (2025).

….............................................................................................................................
LA PRIMERA PARTE, VENDEDOR o LA COMPAÑIA
….............................................................................................
EL COMPRADOR o SEGUNDA PARTE
YO, LIC. YVELISSE VIZCAINO CASTRO, Abogado Notario Público de los del Número Santo Domingo Este, Matricula No. 7247, CERTIFICO Y DOY FE: Que las firmas que aparecen en el presente acto, fueron puestas libre y voluntariamente por los señores; CRISTIAN VARGAS Y {{nombre_cliente}}, cuyas generales constan, quienes han manifestado que esas son las firmas que acostumbran utilizar en todos los actos de sus vidas, tanto públicos como privados. En Santo Domingo, Distrito Nacional, Capital de la República Dominicana el día (3) tre del mes de Marzo del año dos mil veinticinco (2025).

                                                    _________________________________
LIC. YVELISSE VIZCAINO CASTRO
Abogado Notario`;

        // Elementos del DOM
        const modal = document.getElementById("modalContrato");
        const closeBtn = document.querySelector(".close");
        const btnCerrar = document.getElementById("btnCerrar");
        const btnCopiar = document.getElementById("btnCopiar");
        const btnImprimir = document.getElementById("btnImprimir");
        const contratoFinal = document.getElementById("contratoFinal");
        const formContrato = document.getElementById("formContrato");
        
        // Variables para control de bloques
        let currentBlock = 0;
        const totalBlocks = 5;
        
        // Función para cambiar entre bloques
        function changeBlock(nextBlock) {
            // Ocultar bloque actual
            document.getElementById(`block-${currentBlock}`).classList.remove('active');
            
            // Actualizar indicador de progreso
            document.querySelector(`.progress-step[data-step="${currentBlock}"]`).classList.remove('active');
            if (currentBlock > 0) {
                document.querySelector(`.progress-step[data-step="${currentBlock}"]`).classList.add('completed');
            }
            
            // Mostrar nuevo bloque
            document.getElementById(`block-${nextBlock}`).classList.add('active');
            document.querySelector(`.progress-step[data-step="${nextBlock}"]`).classList.add('active');
            
            currentBlock = nextBlock;
        }
        
        // Eventos para botones de navegación
        document.getElementById("btn-next-0").addEventListener("click", function() {
            changeBlock(1);
        });
        
        document.getElementById("btn-next-1").addEventListener("click", function() {
            // Validar campos obligatorios del bloque 1
            const nombre = document.getElementById('nombre_cliente').value;
            const ocupacion = document.getElementById('ocupacion').value;
            const tipoDoc = document.getElementById('tipo_documento').value;
            const numDoc = document.getElementById('numero_documento').value;
            const telefono = document.getElementById('telefono').value;
            const direccion = document.getElementById('direccion').value;
            
            if (!nombre || !ocupacion || !tipoDoc || !numDoc || !telefono || !direccion) {
                Swal.fire({
                    icon: 'error',
                    title: 'Campos obligatorios',
                    text: 'Por favor, complete todos los campos obligatorios del bloque de Datos del Cliente.'
                });
                return;
            }
            
            changeBlock(2);
        });
        
        document.getElementById("btn-prev-1").addEventListener("click", function() {
            changeBlock(0);
        });
        
        document.getElementById("btn-prev-2").addEventListener("click", function() {
            changeBlock(1);
        });
        
        document.getElementById("btn-next-2").addEventListener("click", function() {
            // Validar campos obligatorios del bloque 2
            const tipoVehiculo = document.getElementById('tipo_vehiculo').value;
            const marca = document.getElementById('marca').value;
            const modelo = document.getElementById('modelo').value;
            const anio = document.getElementById('anio').value;
            const placa = document.getElementById('placa').value;
            const color = document.getElementById('color').value;
            const chasis = document.getElementById('chasis').value;
            
            if (!tipoVehiculo || !marca || !modelo || !anio || !placa || !color || !chasis) {
                Swal.fire({
                    icon: 'error',
                    title: 'Campos obligatorios',
                    text: 'Por favor, complete todos los campos obligatorios del bloque de Vehículo.'
                });
                return;
            }
            
            changeBlock(3);
        });
        
        document.getElementById("btn-prev-3").addEventListener("click", function() {
            changeBlock(2);
        });
        
        document.getElementById("btn-next-3").addEventListener("click", function() {
            // Validar campos obligatorios del bloque 3
            const precio = document.getElementById('precio_total').value;
            const montoFin = document.getElementById('monto_financiado').value;
            const cuotas = document.getElementById('cantidad_cuotas').value;
            const montoCuota = document.getElementById('monto_cuota').value;
            const fechaInicio = document.getElementById('fecha_primera_cuota').value;
            const fechaFin = document.getElementById('fecha_ultima_cuota').value;
            
            if (!precio || !montoFin || !cuotas || !montoCuota || !fechaInicio || !fechaFin) {
                Swal.fire({
                    icon: 'error',
                    title: 'Campos obligatorios',
                    text: 'Por favor, complete todos los campos obligatorios del bloque de Financiamiento.'
                });
                return;
            }
            
            changeBlock(4);
        });
        
        document.getElementById("btn-prev-4").addEventListener("click", function() {
            changeBlock(3);
        });

        // Función para formatear fechas
        function formatearFecha(fechaStr) {
            if (!fechaStr) return '';
            const fecha = new Date(fechaStr);
            const dia = fecha.getDate();
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const mes = meses[fecha.getMonth()];
            const anio = fecha.getFullYear();
            return `${dia} de ${mes} del año ${anio}`;
        }

        // Auto-completar desde préstamo seleccionado
        document.getElementById('prestamoSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const monto = selectedOption.getAttribute('data-monto');
                const cliente = selectedOption.getAttribute('data-cliente');
                
                if (monto) {
                    document.getElementById('monto_financiado').value = monto;
                    document.getElementById('precio_total').value = Math.round(monto * 1.2); // Precio total estimado
                    document.getElementById('monto_cuota').value = Math.round(monto / 24); // Cuota estimada para 24 meses
                }
            }
        });

        // Cargar datos de ejemplo (en un caso real, estos vendrían de una API)
        function cargarDatosEjemplo() {
            // Clientes de ejemplo
            const clientes = [
                { id: 1, nombre: 'Juan', apellidos: 'Pérez García', cedula: '001-1234567-8' },
                { id: 2, nombre: 'María', apellidos: 'Rodríguez López', cedula: '002-2345678-9' },
                { id: 3, nombre: 'Carlos', apellidos: 'Martínez Sánchez', cedula: '003-3456789-0' }
            ];
            
            // Préstamos de ejemplo
            const prestamos = [
                { id: 1, monto_aprobado: 400000, cliente_nombre: 'Juan', cliente_apellidos: 'Pérez García' },
                { id: 2, monto_aprobado: 250000, cliente_nombre: 'María', cliente_apellidos: 'Rodríguez López' },
                { id: 3, monto_aprobado: 600000, cliente_nombre: 'Carlos', cliente_apellidos: 'Martínez Sánchez' }
            ];
            
            // Llenar select de clientes
            const clienteSelect = document.getElementById('clienteSelect');
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = `${cliente.nombre} ${cliente.apellidos} - ${cliente.cedula}`;
                clienteSelect.appendChild(option);
            });
            
            // Llenar select de préstamos
            const prestamoSelect = document.getElementById('prestamoSelect');
            prestamos.forEach(prestamo => {
                const option = document.createElement('option');
                option.value = prestamo.id;
                option.textContent = `${prestamo.cliente_nombre} ${prestamo.cliente_apellidos} - RD$ ${Number(prestamo.monto_aprobado).toLocaleString()}`;
                option.setAttribute('data-monto', prestamo.monto_aprobado);
                option.setAttribute('data-cliente', `${prestamo.cliente_nombre} ${prestamo.cliente_apellidos}`);
                prestamoSelect.appendChild(option);
            });
        }

        // Manejar envío del formulario
        formContrato.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validar campos del bloque 4
            const tipoSeguro = document.getElementById('tipo_seguro').value;
            const montoSeguro = document.getElementById('monto_seguro').value;
            
            if (!tipoSeguro || !montoSeguro) {
                Swal.fire({
                    icon: 'error',
                    title: 'Campos obligatorios',
                    text: 'Por favor, complete todos los campos obligatorios del bloque de Seguro.'
                });
                return;
            }
            
            // Obtener todos los valores del formulario
            const formData = new FormData(formContrato);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Generar contrato
            let contratoGenerado = template;
            
            // Reemplazar variables en el template
            contratoGenerado = contratoGenerado.replace(/{{nombre_cliente}}/g, data.nombre_cliente || '');
            contratoGenerado = contratoGenerado.replace(/{{nacionalidad}}/g, data.nacionalidad || '');
            contratoGenerado = contratoGenerado.replace(/{{ocupacion}}/g, data.ocupacion || '');
            contratoGenerado = contratoGenerado.replace(/{{tipo_documento}}/g, data.tipo_documento || '');
            contratoGenerado = contratoGenerado.replace(/{{numero_documento}}/g, data.numero_documento || '');
            contratoGenerado = contratoGenerado.replace(/{{direccion}}/g, data.direccion || '');
            contratoGenerado = contratoGenerado.replace(/{{tipo_vehiculo}}/g, data.tipo_vehiculo || '');
            contratoGenerado = contratoGenerado.replace(/{{marca}}/g, data.marca || '');
            contratoGenerado = contratoGenerado.replace(/{{modelo}}/g, data.modelo || '');
            contratoGenerado = contratoGenerado.replace(/{{anio}}/g, data.anio || '');
            contratoGenerado = contratoGenerado.replace(/{{placa}}/g, data.placa || '');
            contratoGenerado = contratoGenerado.replace(/{{chasis}}/g, data.chasis || '');
            contratoGenerado = contratoGenerado.replace(/{{color}}/g, data.color || '');
            contratoGenerado = contratoGenerado.replace(/{{precio_total}}/g, data.precio_total ? Number(data.precio_total).toLocaleString() : '');
            contratoGenerado = contratoGenerado.replace(/{{monto_financiado}}/g, data.monto_financiado ? Number(data.monto_financiado).toLocaleString() : '');
            contratoGenerado = contratoGenerado.replace(/{{cantidad_cuotas}}/g, data.cantidad_cuotas || '');
            contratoGenerado = contratoGenerado.replace(/{{monto_cuota}}/g, data.monto_cuota ? Number(data.monto_cuota).toLocaleString() : '');
            contratoGenerado = contratoGenerado.replace(/{{fecha_primera_cuota}}/g, formatearFecha(data.fecha_primera_cuota));
            contratoGenerado = contratoGenerado.replace(/{{fecha_ultima_cuota}}/g, formatearFecha(data.fecha_ultima_cuota));
            contratoGenerado = contratoGenerado.replace(/{{monto_seguro}}/g, data.monto_seguro ? Number(data.monto_seguro).toLocaleString() : '');
            
            // Mostrar contrato en el modal
            contratoFinal.textContent = contratoGenerado;
            modal.style.display = "block";
            
            // Mostrar mensaje de éxito
            Swal.fire({
                icon: 'success',
                title: 'Contrato Generado',
                text: 'El contrato ha sido generado exitosamente.'
            });
        });

        // Cerrar modal
        closeBtn.onclick = function() {
            modal.style.display = "none";
        }

        btnCerrar.onclick = function() {
            modal.style.display = "none";
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Copiar contrato al portapapeles
        btnCopiar.onclick = async function() {
            try {
                await navigator.clipboard.writeText(contratoFinal.textContent);
                Swal.fire({
                    icon: 'success',
                    title: 'Éxito',
                    text: 'Contrato copiado al portapapeles'
                });
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al copiar el contrato: ' + err
                });
            }
        };

        // IMPRIMIR CONTRATO - FUNCIÓN CORREGIDA
        btnImprimir.onclick = function() {
            // Crear una ventana nueva específicamente para imprimir
            const ventanaImpresion = window.open('', '_blank');
            const contratoCompleto = contratoFinal.textContent;
            
            ventanaImpresion.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Contrato de Financiamiento - Financiera Caribe Azul</title>
                    <style>
                        body {
                            font-family: 'Times New Roman', serif;
                            font-size: 12px;
                            line-height: 1.4;
                            margin: 20px;
                            color: #000;
                        }
                        .contrato {
                            white-space: pre-wrap;
                            text-align: justify;
                        }
                        .firma {
                            margin-top: 50px;
                            border-top: 1px solid #000;
                            padding-top: 10px;
                            width: 300px;
                        }
                        .firma-izquierda {
                            float: left;
                        }
                        .firma-derecha {
                            float: right;
                        }
                        .clear {
                            clear: both;
                        }
                        @media print {
                            body { margin: 0; }
                            .page-break { page-break-before: always; }
                        }
                    </style>
                </head>
                <body>
                    <div class="contrato">${contratoCompleto}</div>
                    <div class="clear"></div>
                    <div class="firma firma-izquierda">
                        <strong>LA PRIMERA PARTE, VENDEDOR o LA COMPAÑÍA</strong><br>
                        _________________________<br>
                        Firma y sello
                    </div>
                    <div class="firma firma-derecha">
                        <strong>EL COMPRADOR o SEGUNDA PARTE</strong><br>
                        _________________________<br>
                        Firma
                    </div>
                    <div class="clear"></div>
                    <div style="margin-top: 100px; text-align: center;">
                        <div style="border-top: 1px solid #000; padding-top: 10px; width: 60%; margin: 0 auto;">
                            <strong>LIC. YVELISSE VIZCAINO CASTRO</strong><br>
                            Abogado Notario Público<br>
                            Matrícula No. 7247<br>
                            _________________________<br>
                            Firma y sello notarial
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            ventanaImpresion.document.close();
            
            // Esperar a que se cargue el contenido y luego imprimir
            setTimeout(() => {
                ventanaImpresion.print();
                // Opcional: cerrar la ventana después de imprimir
                setTimeout(() => {
                    ventanaImpresion.close();
                }, 100);
            }, 500);
        };

        // Establecer fechas por defecto
        const today = new Date();
        const firstPayment = new Date(today);
        firstPayment.setMonth(today.getMonth() + 1);
        const lastPayment = new Date(firstPayment);
        lastPayment.setMonth(firstPayment.getMonth() + 23); // 24 meses por defecto

        document.getElementById('fecha_primera_cuota').value = firstPayment.toISOString().split('T')[0];
        document.getElementById('fecha_ultima_cuota').value = lastPayment.toISOString().split('T')[0];

        // Cargar datos de ejemplo al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatosEjemplo();
        });
    </script>
</body>
</html>
<%- include('../partials/footer') %>