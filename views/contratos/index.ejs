<%- include('../partials/header', { title: 'Contratos de Financiamiento' }) %>

<div class="container-fluid px-4 mt-4">
  <div class="card border-0 shadow">
    <div class="card-header bg-primary text-white py-3">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0">
          <i class="fas fa-file-contract me-2"></i>Contratos de Financiamiento
        </h2>
                <a href="/contratos/create" class="btn btn-light btn-sm">
          <i class="fas fa-plus me-1"></i> Nuevo Contrato
        </a>
      </div>
    </div>

    <div class="card-body">
            <% if (messages.success && messages.success.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= messages.success[0] %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>
      
      <% if (messages.error && messages.error.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= messages.error[0] %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

            <div class="row mb-4">
                <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body py-3">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <h4 class="mb-0"><%= contratos.length %></h4>
                  <small>Total Contratos</small>
                </div>
                <div class="flex-shrink-0">
                  <i class="fas fa-file-contract fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body py-3">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <h4 class="mb-0">
                    RD$ <%= contratos.reduce((total, c) => total + (parseFloat(c.datos_financiamiento?.monto_financiado) || 0), 0).toLocaleString() %>
                  </h4>
                  <small>Monto Total</small>
                </div>
                <div class="flex-shrink-0">
                  <i class="fas fa-money-bill-wave fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
                  <div class="table-responsive">
        <table class="table table-hover table-striped">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Vehículo</th>
              <th>Financiamiento</th>
              <th>Estado</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% if (contratos.length === 0) { %>
                            <tr>
                <td colspan="7" class="text-center py-4">
                  <div class="text-muted">
                    <i class="fas fa-file-contract fa-3x mb-3"></i>
                    <h5>No hay contratos registrados</h5>
                    <p class="mb-0">Comienza creando tu primer contrato de financiamiento</p>
                    <a href="/contratos/create" class="btn btn-primary mt-3">
                      <i class="fas fa-plus me-1"></i> Crear Primer Contrato
                    </a>
                  </div>
                </td>
              </tr>
            <% } else { %>
              <% contratos.forEach(contrato => { %>
                <tr>
                                    <td>
                    <span class="badge bg-secondary">#<%= contrato.id %></span>
                  </td>
                                    <td>
                    <small class="text-muted d-block">
                      <%= moment(contrato.created_at).format('DD/MM/YYYY') %>
                    </small>
                    <small class="text-muted">
                      <%= moment(contrato.created_at).format('HH:mm') %>
                    </small>
                  </td>
                  <td>
                                        <div class="btn-group btn-group-sm">
                      <a href="/contratos/<%= contrato.id %>" 
                         class="btn btn-outline-primary" 
                         title="Ver detalles" data-bs-toggle="tooltip">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="/contratos/<%= contrato.id %>/download" 
                         class="btn btn-outline-success" 
                         title="Descargar PDF" data-bs-toggle="tooltip">
                        <i class="fas fa-download"></i>
                      </a>
                      <a href="/contratos/<%= contrato.id %>/print" 
                         class="btn btn-outline-info" 
                         target="_blank" title="Imprimir" data-bs-toggle="tooltip">
                        <i class="fas fa-print"></i>
                      </a>
                      <% if (contrato.estado !== 'eliminado') { %>
                        <button class="btn btn-outline-danger delete-contrato" 
                                data-id="<%= contrato.id %>" 
                                data-name="<%= contrato.datos_cliente?.nombre_cliente || 'este contrato' %>"
                                title="Eliminar" data-bs-toggle="tooltip">
                          <i class="fas fa-trash"></i>
                        </button>
                      <% } else { %>
                        <button class="btn btn-outline-secondary" disabled title="Ya eliminado">
                          <i class="fas fa-trash"></i>
                        </button>
                      <% } %>
                    </div>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>