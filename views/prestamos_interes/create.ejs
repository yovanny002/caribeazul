<%- include('../partials/header') %>
<%- include('../partials/flash') %>

<div class="container mt-4">
  <div class="card">
    <div class="card-header">
      <h3 class="mb-0">
        <i class="fas fa-hand-holding-usd"></i> Nuevo Préstamo por Interés
      </h3>
    </div>
    <div class="card-body">
      <form id="prestamoForm" action="/prestamos-interes" method="POST">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label for="cliente_id" class="form-label">Cliente *</label>
              <select class="form-select" id="cliente_id" name="cliente_id" required>
                <option value="">Seleccionar cliente</option>
                <% clientes.forEach(cliente => { %>
                  <option value="<%= cliente.id %>" <%= body.cliente_id == cliente.id ? 'selected' : '' %>>
                    <%= cliente.nombre %> <%= cliente.apellidos %> - <%= cliente.cedula %>
                  </option>
                <% }) %>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label for="ruta_id" class="form-label">Ruta</label>
              <select class="form-select" id="ruta_id" name="ruta_id">
                <option value="">Sin ruta asignada</option>
                <% rutas.forEach(ruta => { %>
                  <option value="<%= ruta.id %>" <%= body.ruta_id == ruta.id ? 'selected' : '' %>>
                    <%= ruta.nombre %> - <%= ruta.zona %>
                  </option>
                <% }) %>
              </select>
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-md-4">
            <div class="form-group mb-3">
              <label for="monto_solicitado" class="form-label">Monto Solicitado (RD$) *</label>
              <input type="number" step="0.01" class="form-control" id="monto_solicitado" 
                     name="monto_solicitado" value="<%= body.monto_solicitado || '' %>" required>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group mb-3">
              <label for="monto_aprobado" class="form-label">Monto Aprobado (RD$) *</label>
              <input type="number" step="0.01" class="form-control" id="monto_aprobado" 
                     name="monto_aprobado" value="<%= body.monto_aprobado || body.monto_solicitado || '' %>" required>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group mb-3">
              <label for="plazo_meses" class="form-label">Plazo (meses) *</label>
              <input type="number" class="form-control" id="plazo_meses" 
                     name="plazo_meses" value="<%= body.plazo_meses || '1' %>" min="1" required>
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label for="forma_pago" class="form-label">Frecuencia de Pago *</label>
              <select class="form-select" id="forma_pago" name="forma_pago" required>
                <option value="diario" <%= body.forma_pago === 'diario' ? 'selected' : '' %>>Diario</option>
                <option value="semanal" <%= body.forma_pago === 'semanal' ? 'selected' : '' %>>Semanal</option>
                <option value="quincenal" <%= body.forma_pago === 'quincenal' ? 'selected' : '' %>>Quincenal</option>
                <option value="mensual" <%= !body.forma_pago || body.forma_pago === 'mensual' ? 'selected' : '' %>>Mensual</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label for="frecuencia_interes" class="form-label">Frecuencia de Interés *</label>
              <select class="form-select" id="frecuencia_interes" name="frecuencia_interes" required>
                <option value="mensual" <%= !body.frecuencia_interes || body.frecuencia_interes === 'mensual' ? 'selected' : '' %>>Mensual</option>
                <option value="quincenal" <%= body.frecuencia_interes === 'quincenal' ? 'selected' : '' %>>Quincenal</option>
              </select>
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label for="interes_porcentaje" class="form-label">Tasa de Interés Anual (%)</label>
              <input type="number" step="0.01" class="form-control" id="interes_porcentaje" 
                     name="interes_porcentaje" value="<%= body.interes_porcentaje || '10' %>">
              <small class="form-text text-muted">Se usará si no se especifica monto manual</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label for="interes_manual" class="form-label">Monto de Interés Manual</label>
              <input type="number" step="0.01" class="form-control" id="interes_manual" 
                     name="interes_manual" value="<%= body.interes_manual || '' %>"
                     placeholder="Ej: 1000 para RD$1,000">
              <small class="form-text text-muted" id="interesManualHelp">
                Ingrese el monto total del interés para el período seleccionado
              </small>
            </div>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-12">
            <div class="form-group mb-3">
              <label for="notas" class="form-label">Notas Adicionales</label>
              <textarea class="form-control" id="notas" name="notas" rows="2"><%= body.notas || '' %></textarea>
            </div>
          </div>
        </div>

        <hr>

        <div class="row mt-4">
          <div class="col-md-12">
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button type="submit" class="btn btn-primary me-md-2">
                <i class="fas fa-save"></i> Guardar Préstamo
              </button>
              <a href="/prestamos-interes" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
              </a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Actualizar ayuda del interés manual según frecuencia
  document.getElementById('frecuencia_interes').addEventListener('change', function() {
    const frecuencia = this.value;
    const helpText = document.getElementById('interesManualHelp');
    
    if (frecuencia === 'quincenal') {
      helpText.textContent = 'Ingrese el monto de interés por quincena (ej: 1000 para RD$1,000 cada 15 días)';
    } else {
      helpText.textContent = 'Ingrese el monto de interés mensual (ej: 2000 para RD$2,000 al mes)';
    }
  });

  // Copiar monto solicitado a monto aprobado si está vacío
  document.getElementById('monto_solicitado').addEventListener('change', function() {
    const montoAprobado = document.getElementById('monto_aprobado');
    if (!montoAprobado.value) {
      montoAprobado.value = this.value;
    }
  });

  // Validación del formulario
  document.getElementById('prestamoForm').addEventListener('submit', function(e) {
    const interesManual = document.getElementById('interes_manual').value;
    const interesPorcentaje = document.getElementById('interes_porcentaje').value;
    
    if (!interesManual && !interesPorcentaje) {
      e.preventDefault();
      alert('Debe ingresar al menos una tasa de interés o un monto manual de interés');
      return false;
    }
    
    return true;
  });
</script>

<%- include('../partials/footer') %>