<%- include('../partials/header', { title: title }) %>

  <style>
    .table-responsive {
      max-height: 70vh;
      overflow-y: auto;
    }
    .table th {
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      z-index: 10;
    }
    .badge {
      font-size: 0.85em;
    }
    .btn-group .btn {
      margin-right: 5px;
    }
    .btn-group .btn:last-child {
      margin-right: 0;
    }
    .modal-body strong {
      color: #007bff;
    }
    .badge.bg-warning {
      color: #212529;
    }
  </style>
</head>
<body>


  <div class="container-fluid mt-3">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Préstamos Pendientes de Aprobación</h3>
            <div class="card-tools">
              <div class="input-group input-group-sm">
                <input type="text" class="form-control" placeholder="Buscar..." id="searchInput">
                <div class="input-group-append">
                  <button class="btn btn-primary">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body table-responsive p-0">
            <table class="table table-hover text-nowrap">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>Tipo</th>
                  <th>Monto Solicitado</th>
                  <th>Fecha Solicitud</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <% if (prestamos.length > 0) { %>
                  <% prestamos.forEach(prestamo => { %>
                    <tr>
                      <td><%= prestamo.id %></td>
                      <td>
                        <% if (prestamo.cliente_nombre) { %>
                          <%= prestamo.cliente_nombre %> <%= prestamo.cliente_apellidos %>
                        <% } else { %>
                          Cliente no encontrado
                        <% } %>
                      </td>
                      <td>
                        <% if (prestamo.tipo === 'especial') { %>
                          <span class="badge bg-info">Especial</span>
                        <% } else { %>
                          <span class="badge bg-primary">Normal</span>
                        <% } %>
                      </td>
                      <td>RD$ <%= formatCurrency(prestamo.monto_solicitado) %></td>
                      <td><%= formatFecha(prestamo.fecha_creacion) %></td>
                      <td>
                        <span class="badge bg-warning">Pendiente</span>
                      </td>
                      <td>
                        <div class="btn-group">
                          <% if (prestamo.tipo === 'especial') { %>
                            <button class="btn btn-sm btn-success" data-toggle="modal" data-target="#aprobarModalEspecial" 
                                    data-id="<%= prestamo.id %>" data-nombre="<%= prestamo.cliente_nombre %> <%= prestamo.cliente_apellidos %>">
                              <i class="fas fa-check"></i> Aprobar
                            </button>
                            <button class="btn btn-sm btn-danger" data-toggle="modal" data-target="#rechazarModalEspecial" 
                                    data-id="<%= prestamo.id %>" data-nombre="<%= prestamo.cliente_nombre %> <%= prestamo.cliente_apellidos %>">
                              <i class="fas fa-times"></i> Rechazar
                            </button>
                          <% } else { %>
                            <button class="btn btn-sm btn-success" data-toggle="modal" data-target="#aprobarModalNormal" 
                                    data-id="<%= prestamo.id %>" data-nombre="<%= prestamo.cliente_nombre %> <%= prestamo.cliente_apellidos %>">
                              <i class="fas fa-check"></i> Aprobar
                            </button>
                            <button class="btn btn-sm btn-danger" data-toggle="modal" data-target="#rechazarModalNormal" 
                                    data-id="<%= prestamo.id %>" data-nombre="<%= prestamo.cliente_nombre %> <%= prestamo.cliente_apellidos %>">
                              <i class="fas fa-times"></i> Rechazar
                            </button>
                          <% } %>
                          <a href="/prestamos/<%= prestamo.id %>" class="btn btn-sm btn-info">
                            <i class="fas fa-eye"></i> Ver
                          </a>
                        </div>
                      </td>
                    </tr>
                  <% }); %>
                <% } else { %>
                  <tr>
                    <td colspan="7" class="text-center">No hay préstamos pendientes de aprobación</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
          <div class="card-footer clearfix">
            <ul class="pagination pagination-sm m-0 float-right">
              <li class="page-item"><a class="page-link" href="#">«</a></li>
              <li class="page-item active"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">»</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para aprobar préstamo especial -->
  <div class="modal fade" id="aprobarModalEspecial" tabindex="-1" role="dialog" aria-labelledby="aprobarModalEspecialLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aprobarModalEspecialLabel">Aprobar Préstamo Especial</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form action="/prestamos-especiales/aprobar/:id" method="POST" id="aprobarEspecialForm">
          <div class="modal-body">
            <p>Estás a punto de aprobar el préstamo especial para <strong id="clienteNombreEspecial"></strong></p>
            <div class="form-group">
              <label for="montoAprobadoEspecial">Monto a aprobar (RD$)</label>
              <input type="number" step="0.01" min="0" class="form-control" id="montoAprobadoEspecial" name="monto_aprobado" required>
            </div>
            <div class="form-group">
              <label for="observacionesEspecial">Observaciones (opcional)</label>
              <textarea class="form-control" id="observacionesEspecial" name="observaciones" rows="3"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Confirmar Aprobación</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para rechazar préstamo especial -->
  <div class="modal fade" id="rechazarModalEspecial" tabindex="-1" role="dialog" aria-labelledby="rechazarModalEspecialLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rechazarModalEspecialLabel">Rechazar Préstamo Especial</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form action="/prestamos-especiales/rechazar/:id" method="POST" id="rechazarEspecialForm">
          <div class="modal-body">
            <p>Estás a punto de rechazar el préstamo especial para <strong id="clienteNombreRechazoEspecial"></strong></p>
            <div class="form-group">
              <label for="motivoRechazoEspecial">Motivo del rechazo</label>
              <textarea class="form-control" id="motivoRechazoEspecial" name="motivo" rows="3" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger">Confirmar Rechazo</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para aprobar préstamo normal -->
  <div class="modal fade" id="aprobarModalNormal" tabindex="-1" role="dialog" aria-labelledby="aprobarModalNormalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aprobarModalNormalLabel">Aprobar Préstamo Normal</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form action="/prestamos/aprobar/:id" method="POST" id="aprobarNormalForm">
          <div class="modal-body">
            <p>Estás a punto de aprobar el préstamo normal para <strong id="clienteNombreNormal"></strong></p>
            <div class="form-group">
              <label for="montoAprobadoNormal">Monto a aprobar (RD$)</label>
              <input type="number" step="0.01" min="0" class="form-control" id="montoAprobadoNormal" name="monto_aprobado" required>
            </div>
            <div class="form-group">
              <label for="interesNormal">Tasa de interés (%)</label>
              <input type="number" step="0.01" min="0" class="form-control" id="interesNormal" name="interes_porcentaje" value="43" required>
            </div>
            <div class="form-group">
              <label for="cuotasNormal">Número de cuotas</label>
              <input type="number" min="1" class="form-control" id="cuotasNormal" name="cuotas" value="12" required>
            </div>
            <div class="form-group">
              <label for="formaPagoNormal">Forma de pago</label>
              <select class="form-control" id="formaPagoNormal" name="forma_pago" required>
                <option value="diario">Diario</option>
                <option value="semanal">Semanal</option>
                <option value="quincenal">Quincenal</option>
                <option value="mensual" selected>Mensual</option>
              </select>
            </div>
            <div class="form-group">
              <label for="observacionesNormal">Observaciones (opcional)</label>
              <textarea class="form-control" id="observacionesNormal" name="observaciones" rows="3"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Confirmar Aprobación</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para rechazar préstamo normal -->
  <div class="modal fade" id="rechazarModalNormal" tabindex="-1" role="dialog" aria-labelledby="rechazarModalNormalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rechazarModalNormalLabel">Rechazar Préstamo Normal</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form action="/prestamos/rechazar/:id" method="POST" id="rechazarNormalForm">
          <div class="modal-body">
            <p>Estás a punto de rechazar el préstamo normal para <strong id="clienteNombreRechazoNormal"></strong></p>
            <div class="form-group">
              <label for="motivoRechazoNormal">Motivo del rechazo</label>
              <textarea class="form-control" id="motivoRechazoNormal" name="motivo" rows="3" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger">Confirmar Rechazo</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- jQuery, Popper.js, Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

  <script>
  $(document).ready(function() {
    // Configurar modales para préstamos especiales
    $('#aprobarModalEspecial').on('show.bs.modal', function(event) {
      const button = $(event.relatedTarget);
      const id = button.data('id');
      const nombre = button.data('nombre');
      const modal = $(this);
      modal.find('#clienteNombreEspecial').text(nombre);
      modal.find('form').attr('action', `/prestamos-especiales/aprobar/${id}`);
    });

    $('#rechazarModalEspecial').on('show.bs.modal', function(event) {
      const button = $(event.relatedTarget);
      const id = button.data('id');
      const nombre = button.data('nombre');
      const modal = $(this);
      modal.find('#clienteNombreRechazoEspecial').text(nombre);
      modal.find('form').attr('action', `/prestamos-especiales/rechazar/${id}`);
    });

    // Configurar modales para préstamos normales
    $('#aprobarModalNormal').on('show.bs.modal', function(event) {
      const button = $(event.relatedTarget);
      const id = button.data('id');
      const nombre = button.data('nombre');
      const modal = $(this);
      modal.find('#clienteNombreNormal').text(nombre);
      modal.find('form').attr('action', `/prestamos/aprobar/${id}`);
    });

    $('#rechazarModalNormal').on('show.bs.modal', function(event) {
      const button = $(event.relatedTarget);
      const id = button.data('id');
      const nombre = button.data('nombre');
      const modal = $(this);
      modal.find('#clienteNombreRechazoNormal').text(nombre);
      modal.find('form').attr('action', `/prestamos/rechazar/${id}`);
    });

    // Búsqueda en la tabla
    $('#searchInput').keyup(function() {
      const value = $(this).val().toLowerCase();
      $('table tbody tr').filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
      });
    });
  });
  </script>
</body>
</html>
<%- include('../partials/footer') %>
